<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel Interno da Agenda</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Roboto+Mono:wght@500&display=swap');

    :root {
      font-family: "Manrope", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      color: #051127;
      background-color: #edf3ff;
      --primary: #2962ff;
      --accent: #00c6ae;
      --danger: #ff7c6b;
      --muted: #5c6b80;
      --surface: #ffffff;
      --surface-soft: rgba(255, 255, 255, 0.85);
      --border: #e1e6f0;
      --shadow-lg: 0 30px 70px rgba(8, 24, 68, 0.18);
      --shadow-soft: 0 15px 40px rgba(10, 41, 88, 0.14);
      --radius: 24px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top left, #f1fbfe, #ebf2ff 35%, #fdfefe 70%);
      color: #051127;
    }

    h1,
    h2,
    h3,
    h4 {
      font-weight: 600;
      margin: 0;
      color: inherit;
    }

    button {
      font-family: inherit;
    }

    a {
      color: var(--primary);
    }

    .app-hero {
      background: linear-gradient(135deg, #00c6ae 0%, #2f6bff 45%, #0d2c5a 100%);
      color: #f5fbff;
      padding: 2.5rem clamp(1.5rem, 5vw, 3.5rem);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      box-shadow: var(--shadow-lg);
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.2);
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .hero-copy {
      margin: 0.75rem 0 1.5rem;
      color: rgba(255, 255, 255, 0.85);
      max-width: 38ch;
    }

    .hero-date-card {
      background: rgba(5, 10, 24, 0.35);
      padding: 1rem 1.25rem;
      border-radius: 18px;
      display: inline-flex;
      flex-direction: column;
      gap: 0.35rem;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
    }

    .hero-date-label {
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .hero-date-display {
      font-size: 1.15rem;
      font-weight: 600;
    }

    .hero-slot-summary {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.75);
    }

    .hero-col--actions {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .hero-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 0.85rem;
    }

    .hero-pill {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 0.85rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.85rem;
    }

    .hero-pill strong {
      font-size: 1.3rem;
      font-family: "Roboto Mono", monospace;
      color: #fff;
    }

    .hero-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .action-primary,
    .action-secondary {
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.6rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }

    .action-primary {
      background: #fff;
      color: #0e2c53;
      box-shadow: 0 18px 35px rgba(16, 48, 95, 0.35);
    }

    .action-secondary {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.45);
      color: #fff;
    }

    .action-primary:hover,
    .action-secondary:hover {
      transform: translateY(-2px);
    }

    main {
      width: min(1500px, 100%);
      margin: -2.5rem auto 3rem;
      padding: 0 clamp(1.25rem, 4vw, 3rem) 3rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .day-carousel,
    .filters-panel,
    .timeline-card,
    .detail-panel,
    .quick-panel {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
    }

    .day-carousel {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .carousel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .carousel-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.15rem;
    }

    .carousel-status {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .clear-filter {
      border: none;
      background: rgba(41, 98, 255, 0.1);
      color: var(--primary);
      font-weight: 600;
      border-radius: 999px;
      padding: 0.45rem 1rem;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .clear-filter:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .day-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 0.65rem;
    }

    .day-chip {
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 0.75rem 0.9rem;
      text-align: left;
      background: var(--surface-soft);
      font-weight: 600;
      color: #132033;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s ease, background 0.2s ease;
    }

    .day-chip span {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    .day-chip strong {
      display: block;
      font-size: 1.15rem;
      margin-top: 0.2rem;
    }

    .day-chip.active {
      background: linear-gradient(135deg, var(--accent), var(--primary));
      color: #fff;
      border-color: transparent;
      box-shadow: 0 12px 30px rgba(41, 98, 255, 0.25);
    }

    .filters-panel {
      padding: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
    }

    .filter-field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    .filter-field select,
    .filter-field input {
      padding: 0.85rem 0.9rem;
      border-radius: 15px;
      border: 1px solid var(--border);
      font-size: 1rem;
      color: #0b1734;
      background: #fdfefe;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .filter-field select:focus,
    .filter-field input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.15);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: minmax(0, 2.6fr) minmax(280px, 1fr) minmax(220px, 0.85fr);
      gap: 1.5rem;
    }

    .timeline-card {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .card-subtitle {
      font-size: 0.9rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.2rem;
    }

    .card-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .legend-pill {
      padding: 0.25rem 0.9rem;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 700;
      border: 1px solid rgba(15, 30, 65, 0.08);
    }

    .table-wrapper {
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      background: var(--surface);
    }

    thead th {
      background: linear-gradient(120deg, rgba(41, 98, 255, 0.95), rgba(0, 198, 174, 0.85));
      color: #fff;
      padding: 0.9rem 0.75rem;
      text-align: left;
      font-weight: 500;
      font-size: 0.85rem;
      letter-spacing: 0.03em;
    }

    tbody td {
      padding: 0.8rem 0.75rem;
      border-bottom: 1px solid #edf0f7;
      color: #0b1734;
      position: relative;
    }

    tbody tr {
      transition: background 0.2s ease;
    }

    tbody tr:hover {
      background: rgba(41, 98, 255, 0.04);
    }

    .row-selected {
      background: rgba(0, 198, 174, 0.08);
      box-shadow: inset 3px 0 0 0 var(--accent);
    }

    td.small {
      font-size: 0.82rem;
      color: var(--muted);
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
    }

    .status-disponivel {
      background: #e0fefd;
      color: #02655d;
    }

    .status-aguardando_upload {
      background: #fff4d4;
      color: #a56200;
    }

    .status-reservado {
      background: #e6edff;
      color: #2b3b94;
    }

    .status-cancelado {
      background: #ffe0dd;
      color: #b42318;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .action-btn {
      border: none;
      border-radius: 14px;
      padding: 0.4rem 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .action-btn.edit-btn {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 12px 25px rgba(41, 98, 255, 0.25);
    }

    .action-btn.delete-btn {
      background: rgba(255, 124, 107, 0.12);
      color: var(--danger);
    }

    .action-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }

    .table-empty {
      text-align: center;
      padding: 2rem !important;
      color: var(--muted);
    }

    .detail-panel {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 100%;
    }

    .detail-empty {
      color: var(--muted);
      line-height: 1.6;
    }

    .detail-status {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .detail-slot {
      font-size: 0.95rem;
      color: var(--muted);
    }

    .detail-shopping {
      color: var(--primary);
      font-weight: 600;
    }

    .detail-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin: 0;
    }

    .detail-list div {
      background: #f7f9fd;
      border-radius: 14px;
      padding: 0.75rem;
    }

    .detail-list dt {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0 0 0.35rem;
      color: var(--muted);
    }

    .detail-list dd {
      margin: 0;
      font-weight: 600;
      color: #0b1734;
      word-break: break-word;
    }

    .detail-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .detail-btn {
      flex: 1;
      border: none;
      border-radius: 12px;
      padding: 0.6rem 1rem;
      font-weight: 600;
      cursor: pointer;
      background: rgba(41, 98, 255, 0.12);
      color: var(--primary);
      transition: transform 0.2s ease;
    }

    .detail-btn.danger {
      background: rgba(255, 124, 107, 0.15);
      color: var(--danger);
    }

    .detail-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .quick-panel {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 100%;
    }

    .quick-panel p {
      margin: 0;
      color: var(--muted);
    }

    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .quick-action {
      border: none;
      border-radius: 16px;
      padding: 0.9rem 1rem;
      text-align: left;
      font-weight: 600;
      background: #f6f7fb;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      color: #0b1734;
    }

    .quick-action.primary {
      background: linear-gradient(120deg, var(--accent), var(--primary));
      color: #fff;
      box-shadow: 0 18px 40px rgba(41, 98, 255, 0.25);
    }

    .quick-action:hover:not(:disabled) {
      transform: translateY(-2px);
    }

    .quick-action:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }

    .quick-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      border-radius: 14px;
      background: #f7f9fd;
      font-weight: 600;
    }

    dialog::backdrop {
      background: rgba(5, 10, 24, 0.55);
    }

    dialog {
      border: none;
      border-radius: 1.3rem;
      padding: 0;
      width: min(760px, 90%);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    .dialog-head {
      background: linear-gradient(135deg, var(--primary), #0f2d63);
      color: #fff;
      padding: 1.4rem 1.5rem;
    }

    .dialog-body {
      background: #fff;
      padding: 1.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .form-control {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .form-control input,
    .form-control select,
    .form-control textarea {
      border: 1px solid var(--border);
      border-radius: 0.9rem;
      padding: 0.6rem 0.75rem;
      font-size: 0.95rem;
      color: #0f172a;
      background: #fff;
      min-height: 44px;
    }

    .form-control textarea {
      resize: vertical;
      min-height: 96px;
    }

    .form-control input:focus,
    .form-control select:focus,
    .form-control textarea:focus {
      outline: 2px solid rgba(41, 98, 255, 0.2);
      border-color: var(--primary);
    }

    .form-control input[readonly] {
      background: #f1f5f9;
      color: #94a3b8;
    }

    .form-actions {
      margin-top: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .form-message {
      font-size: 0.9rem;
      color: var(--danger);
    }

    .toast {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      padding: 0.9rem 1.2rem;
      border-radius: 0.9rem;
      font-weight: 600;
      color: #fff;
      background: var(--primary);
      opacity: 0;
      transform: translateY(-20px);
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      box-shadow: var(--shadow-soft);
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .detail-panel,
      .quick-panel {
        min-height: auto;
      }
    }

    @media (max-width: 900px) {
      thead th:nth-child(7),
      thead th:nth-child(8),
      thead th:nth-child(9),
      tbody td:nth-child(7),
      tbody td:nth-child(8),
      tbody td:nth-child(9) {
        display: none;
      }
    }

    @media (max-width: 640px) {
      .hero-buttons {
        flex-direction: column;
        width: 100%;
      }

      .action-primary,
      .action-secondary {
        width: 100%;
      }

      .filters-panel {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="app-hero">
    <div>
      <span class="hero-badge">Clinique Neo</span>
      <h1>Agenda diária</h1>
      <p class="hero-copy">Coordene atendimentos com foco no paciente: visualize horários, detalhe cada contato e execute ações sem perder o contexto.</p>
      <div class="hero-date-card">
        <span class="hero-date-label">Hoje</span>
        <span id="heroCurrentDate" class="hero-date-display">-</span>
        <span id="heroSlotSummary" class="hero-slot-summary">Carregando agenda...</span>
      </div>
    </div>
    <div class="hero-col--actions">
      <div class="hero-stats">
        <div class="hero-pill">
          <span>Confirmados</span>
          <strong id="statReservado">0</strong>
        </div>
        <div class="hero-pill">
          <span>Em triagem</span>
          <strong id="statPending">0</strong>
        </div>
        <div class="hero-pill">
          <span>Disponíveis</span>
          <strong id="statDisponivel">0</strong>
        </div>
      </div>
      <div class="hero-buttons">
        <button id="refreshButton" class="action-primary" type="button">Recarregar agenda</button>
        <button id="logoutButton" class="action-secondary" type="button">Trocar acesso</button>
      </div>
    </div>
  </header>

  <main>
    <section class="day-carousel">
      <div class="carousel-head">
        <div>
          <p class="carousel-title">Próximos dias</p>
          <span id="carouselStatus" class="carousel-status">Aguardando dados da agenda</span>
        </div>
        <button id="clearDateFilter" class="clear-filter" type="button" disabled>Limpar filtro</button>
      </div>
      <div id="dayCarousel" class="day-list"></div>
    </section>

    <section class="filters-panel">
      <label class="filter-field">
        Data
        <select id="dateFilter">
          <option value="">Todas</option>
        </select>
      </label>
      <label class="filter-field">
        Status
        <select id="statusFilter">
          <option value="">Todos</option>
          <option value="disponivel">Disponível</option>
          <option value="aguardando_upload">Aguardando Upload</option>
          <option value="reservado">Reservado</option>
          <option value="cancelado">Cancelado</option>
        </select>
      </label>
      <label class="filter-field">
        Buscar
        <input
          id="searchFilter"
          type="search"
          placeholder="Nome, contato, telefone ou e-mail"
        />
      </label>
    </section>

    <section class="dashboard-grid">
      <div class="timeline-card">
        <div class="card-head">
          <div>
            <p class="card-subtitle">Linha do tempo</p>
            <h2>Horários cadastrados</h2>
          </div>
          <div class="card-legend">
            <span class="legend-pill">Confirmado</span>
            <span class="legend-pill">Upload pendente</span>
            <span class="legend-pill">Disponível</span>
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Horário</th>
                <th>Status</th>
                <th>Shopping / Loja</th>
                <th>Contato</th>
                <th>Telefone</th>
                <th>E-mail</th>
                <th>Informações</th>
                <th>Upload</th>
                <th>Reservado em</th>
                <th>Expira em</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="agendaTableBody">
              <tr>
                <td colspan="12" class="table-empty">Carregando agenda...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <aside class="detail-panel" id="detailPanel">
        <div class="detail-empty">
          <h3>Selecione um horário</h3>
          <p>Os detalhes completos aparecem aqui para você acompanhar cada contato sem sair da linha do tempo.</p>
        </div>
      </aside>

      <aside class="quick-panel">
        <div>
          <h3>Ações rápidas</h3>
          <p>Atalhos para as rotinas mais frequentes no painel.</p>
        </div>
        <div class="quick-actions">
          <button id="reserveFirstAvailable" class="quick-action primary" type="button">Reservar primeiro horário disponível</button>
          <button id="exportAgenda" class="quick-action" type="button">Exportar agenda em CSV</button>
          <button id="releaseSelectedSlot" class="quick-action" type="button" disabled>Liberar horário selecionado</button>
        </div>
        <div class="quick-meta">
          <span>Slots carregados</span>
          <strong id="quickTotalSlots">0</strong>
        </div>
      </aside>
    </section>
  </main>

  <dialog id="editorDialog">
    <div class="dialog-head">
      <h2 id="dialogTitle" style="margin: 0; font-size: 1.2rem;">Editar agendamento</h2>
    </div>
    <div class="dialog-body">
      <form id="editorForm">
        <input type="hidden" name="id" />
        <input type="hidden" name="rowKey" />
        <div class="form-grid">
          <label class="form-control">
            Data
            <input name="data" type="date" readonly required />
          </label>
          <label class="form-control">
            Horário
            <input name="horario" type="text" readonly required />
          </label>
          <label class="form-control">
            Status
            <select name="status" required>
              <option value="aguardando_upload">Aguardando upload</option>
              <option value="reservado">Reservado</option>
              <option value="cancelado">Cancelado</option>
            </select>
          </label>
          <label class="form-control">
            Shopping
            <input name="shopping" type="text" />
          </label>
          <label class="form-control">
            Nome fantasia
            <input name="nome_fantasia" type="text" />
          </label>
          <label class="form-control">
            Nome do contato
            <input name="nome_contato" type="text" />
          </label>
          <label class="form-control">
            Telefone / WhatsApp
            <input name="telefone_whatsapp" type="text" />
          </label>
          <label class="form-control">
            E-mail
            <input name="email" type="email" />
          </label>
          <label class="form-control" style="grid-column: 1 / -1;">
            Informações adicionais
            <textarea name="informacoes_adicionais" maxlength="200"></textarea>
          </label>
          <label class="form-control">
            Upload (URL)
            <input name="upload_url" type="text" />
          </label>
          <label class="form-control">
            Upload (tipo)
            <input name="upload_tipo" type="text" placeholder="pdf, imagem..." />
          </label>
          <label class="form-control">
            Upload (MB)
            <input name="upload_tamanho_mb" type="number" min="0" step="0.01" />
          </label>
          <label class="form-control">
            Data/hora da reserva
            <input name="data_hora_reserva" type="datetime-local" />
          </label>
          <label class="form-control">
            Expira em
            <input name="expira_em" type="datetime-local" />
          </label>
        </div>

        <div class="form-actions">
          <span id="formMessage" class="form-message"></span>
          <div style="display: flex; gap: 0.6rem;">
            <button type="button" id="cancelEditBtn" class="action-btn ghost">Cancelar</button>
            <button type="submit" class="action-btn edit-btn">Salvar</button>
          </div>
        </div>
      </form>
    </div>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    (() => {
      'use strict';

      const TOKEN_STORAGE_KEY = 'tz-admin-token';
      const ADMIN_LOGIN_HINT = 'Use o botão "admin" no site principal e faça login com sua conta autorizada.';

      const state = {
        agenda: [],
        dates: [],
        slots: [],
        token: null,
        selectedRowKey: null
      };

      const tableBody = document.getElementById('agendaTableBody');
      const dateFilter = document.getElementById('dateFilter');
      const statusFilter = document.getElementById('statusFilter');
      const searchFilter = document.getElementById('searchFilter');
      const refreshButton = document.getElementById('refreshButton');
      const logoutButton = document.getElementById('logoutButton');
      const dialog = document.getElementById('editorDialog');
      const dialogTitle = document.getElementById('dialogTitle');
      const form = document.getElementById('editorForm');
      const formMessage = document.getElementById('formMessage');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const toast = document.getElementById('toast');
      const heroCurrentDate = document.getElementById('heroCurrentDate');
      const heroSlotSummary = document.getElementById('heroSlotSummary');
      const statReservado = document.getElementById('statReservado');
      const statPending = document.getElementById('statPending');
      const statDisponivel = document.getElementById('statDisponivel');
      const dayCarousel = document.getElementById('dayCarousel');
      const carouselStatus = document.getElementById('carouselStatus');
      const clearDateButton = document.getElementById('clearDateFilter');
      const detailPanel = document.getElementById('detailPanel');
      const quickTotalSlots = document.getElementById('quickTotalSlots');
      const quickReserveBtn = document.getElementById('reserveFirstAvailable');
      const quickExportBtn = document.getElementById('exportAgenda');
      const quickReleaseSelectedBtn = document.getElementById('releaseSelectedSlot');

      function captureTokenFromHash() {
        const hash = window.location.hash.replace(/^#/, '');
        const params = new URLSearchParams(hash);
        const token = params.get('token');
        if (token) {
          sessionStorage.setItem(TOKEN_STORAGE_KEY, token);
          const cleanUrl = window.location.pathname + window.location.search;
          window.history.replaceState(null, '', cleanUrl);
          return token;
        }
        return null;
      }

      function restoreToken() {
        return sessionStorage.getItem(TOKEN_STORAGE_KEY);
      }

      function clearToken() {
        sessionStorage.removeItem(TOKEN_STORAGE_KEY);
        state.token = null;
      }

      function ensureAuthorized(showAlert = false) {
        if (state.token) return true;
        setTableMessage(`Acesso restrito. ${ADMIN_LOGIN_HINT}`);
        if (showAlert) {
          showToast('Acesso restrito. Abra o painel pelo botão "admin".', true);
        }
        return false;
      }

      function handleUnauthorized() {
        clearToken();
        ensureAuthorized(true);
      }

      state.token = captureTokenFromHash() || restoreToken();

      function formatDate(dateStr) {
        if (!dateStr) return '-';
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}/${year}`;
      }

      function formatChipDate(dateStr) {
        if (!dateStr) return '--';
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}`;
      }

      function formatWeekday(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        if (Number.isNaN(date.getTime())) return '';
        return date.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
      }

      function formatDateTime(value) {
        if (!value) return '-';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '-';
        return date.toLocaleString('pt-BR', {
          dateStyle: 'short',
          timeStyle: 'short'
        });
      }

      function toInputDateTime(value) {
        if (!value) return '';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '';
        const pad = (num) => String(num).padStart(2, '0');
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
      }

      function escapeHtml(value) {
        if (value === null || value === undefined) return '';
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function statusLabel(status) {
        const map = {
          disponivel: 'Disponível',
          aguardando_upload: 'Aguardando upload',
          reservado: 'Reservado',
          cancelado: 'Cancelado'
        };
        return map[status] ?? status;
      }

      function setTableMessage(message) {
        tableBody.innerHTML = '';
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 12;
        cell.className = 'table-empty';
        cell.textContent = message;
        row.appendChild(cell);
        tableBody.appendChild(row);
        state.selectedRowKey = null;
        renderDetailPanel(null);
        highlightSelectedRow();
        updateHeroSummary();
      }

      function populateDateFilter(selected) {
        const currentValue = selected ?? dateFilter.value ?? '';
        dateFilter.innerHTML = '<option value="">Todas</option>';
        state.dates.forEach((date) => {
          const option = document.createElement('option');
          option.value = date;
          option.textContent = formatDate(date);
          dateFilter.appendChild(option);
        });

        if (currentValue && state.dates.includes(currentValue)) {
          dateFilter.value = currentValue;
        }
        buildDayCarousel();
      }

      function hydrateAgenda(list) {
        return list.map((item) => ({
          ...item,
          rowKey: `${item.data}|${item.horario}`,
          upload_arquivo: item.upload_arquivo ?? {
            url: null,
            tipo: null,
            tamanho_mb: null
          }
        }));
      }

      function updateHeroSummary() {
        const now = new Date();
        if (heroCurrentDate) {
          heroCurrentDate.textContent = now.toLocaleDateString('pt-BR', {
            weekday: 'long',
            day: '2-digit',
            month: 'short'
          });
        }
        const total = state.agenda.length;
        if (heroSlotSummary) {
          heroSlotSummary.textContent = total ? `${total} horário(s) sincronizados` : 'Nenhum horário carregado';
        }
        if (quickTotalSlots) {
          quickTotalSlots.textContent = total;
        }
        const stats = state.agenda.reduce(
          (acc, item) => {
            acc[item.status] = (acc[item.status] ?? 0) + 1;
            return acc;
          },
          {}
        );
        if (statReservado) statReservado.textContent = stats.reservado ?? 0;
        if (statPending) statPending.textContent = stats.aguardando_upload ?? 0;
        if (statDisponivel) statDisponivel.textContent = stats.disponivel ?? 0;
      }

      function buildDayCarousel() {
        if (!dayCarousel) return;
        dayCarousel.innerHTML = '';
        if (carouselStatus) {
          const totalDays = state.dates.length;
          carouselStatus.textContent = totalDays
            ? `${totalDays} dia(s) disponíveis na agenda`
            : 'Nenhuma data disponível';
        }
        if (clearDateButton) {
          clearDateButton.disabled = !dateFilter.value;
        }
        state.dates.slice(0, 8).forEach((date) => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = `day-chip${dateFilter.value === date ? ' active' : ''}`;
          button.innerHTML = `<span>${formatWeekday(date)}</span><strong>${formatChipDate(date)}</strong>`;
          button.addEventListener('click', () => {
            dateFilter.value = dateFilter.value === date ? '' : date;
            renderTable();
            buildDayCarousel();
          });
          dayCarousel.appendChild(button);
        });
      }

      async function loadAgenda() {
        if (!ensureAuthorized()) return;
        setTableMessage('Carregando agenda...');
        try {
          const response = await fetch('/api/admin/agenda', {
            headers: {
              Authorization: `Bearer ${state.token}`
            }
          });
          if (response.status === 401 || response.status === 403) {
            handleUnauthorized();
            return;
          }
          if (!response.ok) {
            throw new Error('Falha ao carregar');
          }
          const payload = await response.json();
          state.agenda = hydrateAgenda(payload.agenda ?? []);
          state.dates = payload.dates ?? [];
          state.slots = payload.slots ?? [];
          populateDateFilter();
          renderTable();
          showToast('Agenda atualizada');
        } catch (error) {
          console.error(error);
          setTableMessage('Não foi possível carregar os dados neste momento.');
          showToast('Erro ao buscar dados', true);
        }
      }

      function applyFilters(row) {
        if (dateFilter.value && row.data !== dateFilter.value) return false;
        if (statusFilter.value && row.status !== statusFilter.value) return false;
        const query = searchFilter.value.trim().toLowerCase();
        if (!query) return true;
        const searchable = [
          row.shopping,
          row.nome_fantasia,
          row.nome_contato,
          row.telefone_whatsapp,
          row.email
        ]
          .join(' ')
          .toLowerCase();
        return searchable.includes(query);
      }

      function getSelectedRow() {
        if (!state.selectedRowKey) return null;
        return state.agenda.find((item) => item.rowKey === state.selectedRowKey) ?? null;
      }

      function highlightSelectedRow() {
        const rows = tableBody.querySelectorAll('tr[data-row-key]');
        rows.forEach((row) => {
          if (row.dataset.rowKey === state.selectedRowKey) {
            row.classList.add('row-selected');
          } else {
            row.classList.remove('row-selected');
          }
        });
      }

      function renderDetailPanel(row) {
        if (!detailPanel) return;
        if (quickReleaseSelectedBtn) {
          quickReleaseSelectedBtn.disabled = !row || !row.id;
        }
        if (!row) {
          detailPanel.innerHTML = `
            <div class="detail-empty">
              <h3>Selecione um horário</h3>
              <p>Os detalhes completos aparecem aqui para você acompanhar cada contato sem sair da linha do tempo.</p>
            </div>
          `;
          return;
        }
        const upload = row.upload_arquivo || {};
        const uploadLabel = upload.url
          ? `<a href="${escapeHtml(upload.url)}" target="_blank" rel="noreferrer">${escapeHtml(upload.tipo ? upload.tipo.toUpperCase() : 'Arquivo')}${upload.tamanho_mb ? ` (${escapeHtml(upload.tamanho_mb)} MB)` : ''}</a>`
          : '-';
        detailPanel.innerHTML = `
          <div class="detail-status">
            <span class="status-chip status-${row.status}">${statusLabel(row.status)}</span>
            <span class="detail-slot">${formatDate(row.data)} · ${row.horario}</span>
          </div>
          <h3>${escapeHtml(row.nome_fantasia || 'Sem nome fantasia')}</h3>
          <p class="detail-shopping">${escapeHtml(row.shopping || 'Sem shopping informado')}</p>
          <dl class="detail-list">
            <div>
              <dt>Contato</dt>
              <dd>${escapeHtml(row.nome_contato || '-')}</dd>
            </div>
            <div>
              <dt>WhatsApp</dt>
              <dd>${escapeHtml(row.telefone_whatsapp || '-')}</dd>
            </div>
            <div>
              <dt>E-mail</dt>
              <dd>${escapeHtml(row.email || '-')}</dd>
            </div>
            <div>
              <dt>Notas</dt>
              <dd>${escapeHtml(row.informacoes_adicionais || '-')}</dd>
            </div>
            <div>
              <dt>Upload</dt>
              <dd>${uploadLabel}</dd>
            </div>
            <div>
              <dt>Reservado em</dt>
              <dd>${formatDateTime(row.data_hora_reserva)}</dd>
            </div>
            <div>
              <dt>Expira em</dt>
              <dd>${formatDateTime(row.expira_em)}</dd>
            </div>
          </dl>
          <div class="detail-actions">
            <button class="detail-btn" type="button" data-action="edit" data-row-key="${row.rowKey}">Editar</button>
            ${row.id ? `<button class="detail-btn danger" type="button" data-action="release" data-id="${row.id}" data-row-key="${row.rowKey}">Liberar</button>` : ''}
          </div>
        `;
      }

      function renderTable() {
        updateHeroSummary();
        const rows = state.agenda
          .slice()
          .sort((a, b) => a.data.localeCompare(b.data) || a.horario.localeCompare(b.horario))
          .filter(applyFilters);

        if (state.selectedRowKey && !rows.some((item) => item.rowKey === state.selectedRowKey)) {
          state.selectedRowKey = null;
        }

        if (!rows.length) {
          setTableMessage('Nenhum registro encontrado para os filtros selecionados.');
          return;
        }

        tableBody.innerHTML = '';

        rows.forEach((item) => {
          const tr = document.createElement('tr');
          tr.dataset.rowKey = item.rowKey;

          const dateCell = document.createElement('td');
          dateCell.textContent = formatDate(item.data);
          tr.appendChild(dateCell);

          const timeCell = document.createElement('td');
          timeCell.textContent = item.horario;
          tr.appendChild(timeCell);

          const statusCell = document.createElement('td');
          const chip = document.createElement('span');
          chip.className = `status-chip status-${item.status}`;
          chip.textContent = statusLabel(item.status);
          statusCell.appendChild(chip);
          tr.appendChild(statusCell);

          const shoppingCell = document.createElement('td');
          const shoppingName = document.createElement('div');
          shoppingName.style.fontWeight = '600';
          shoppingName.textContent = item.shopping || '-';
          const loja = document.createElement('div');
          loja.className = 'small';
          loja.textContent = item.nome_fantasia || '-';
          shoppingCell.appendChild(shoppingName);
          shoppingCell.appendChild(loja);
          tr.appendChild(shoppingCell);

          const contatoCell = document.createElement('td');
          contatoCell.textContent = item.nome_contato || '-';
          tr.appendChild(contatoCell);

          const telefoneCell = document.createElement('td');
          telefoneCell.textContent = item.telefone_whatsapp || '-';
          tr.appendChild(telefoneCell);

          const emailCell = document.createElement('td');
          emailCell.textContent = item.email || '-';
          tr.appendChild(emailCell);

          const infoCell = document.createElement('td');
          infoCell.textContent = item.informacoes_adicionais || '-';
          tr.appendChild(infoCell);

          const uploadCell = document.createElement('td');
          const upload = item.upload_arquivo || {};
          if (upload.url) {
            const link = document.createElement('a');
            link.href = upload.url;
            link.target = '_blank';
            link.rel = 'noreferrer';
            link.textContent = upload.tipo ? upload.tipo.toUpperCase() : 'Arquivo';
            uploadCell.appendChild(link);
            if (upload.tamanho_mb) {
              const span = document.createElement('span');
              span.className = 'small';
              span.textContent = ` (${upload.tamanho_mb} MB)`;
              uploadCell.appendChild(span);
            }
          } else {
            uploadCell.textContent = '-';
          }
          tr.appendChild(uploadCell);

          const reservaCell = document.createElement('td');
          reservaCell.textContent = formatDateTime(item.data_hora_reserva);
          tr.appendChild(reservaCell);

          const expiraCell = document.createElement('td');
          expiraCell.textContent = formatDateTime(item.expira_em);
          tr.appendChild(expiraCell);

          const actionCell = document.createElement('td');
          actionCell.className = 'actions';
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'action-btn edit-btn';
          editBtn.dataset.rowKey = item.rowKey;
          editBtn.textContent = item.id ? 'Editar' : 'Reservar';
          actionCell.appendChild(editBtn);

          if (item.id) {
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'action-btn delete-btn';
            deleteBtn.dataset.id = item.id;
            deleteBtn.dataset.rowKey = item.rowKey;
            deleteBtn.textContent = 'Liberar';
            actionCell.appendChild(deleteBtn);
          }

          tr.appendChild(actionCell);
          tableBody.appendChild(tr);
        });

        if (!state.selectedRowKey && rows.length) {
          state.selectedRowKey = rows[0].rowKey;
        }

        highlightSelectedRow();
        renderDetailPanel(getSelectedRow());
      }

      function openEditor(row) {
        form.reset();
        formMessage.textContent = '';

        dialogTitle.textContent = row.id ? 'Editar agendamento' : 'Reservar horário';
        form.elements.id.value = row.id ?? '';
        form.elements.rowKey.value = row.rowKey;
        form.elements.data.value = row.data;
        form.elements.horario.value = row.horario;
        form.elements.status.value = row.status === 'disponivel' ? 'aguardando_upload' : row.status;
        form.elements.shopping.value = row.shopping || '';
        form.elements.nome_fantasia.value = row.nome_fantasia || '';
        form.elements.nome_contato.value = row.nome_contato || '';
        form.elements.telefone_whatsapp.value = row.telefone_whatsapp || '';
        form.elements.email.value = row.email || '';
        form.elements.informacoes_adicionais.value = row.informacoes_adicionais || '';
        form.elements.upload_url.value = row.upload_arquivo?.url || '';
        form.elements.upload_tipo.value = row.upload_arquivo?.tipo || '';
        form.elements.upload_tamanho_mb.value = row.upload_arquivo?.tamanho_mb ?? '';
        form.elements.data_hora_reserva.value = toInputDateTime(row.data_hora_reserva);
        form.elements.expira_em.value = toInputDateTime(row.expira_em);

        if (typeof dialog.showModal === 'function') {
          dialog.showModal();
        } else {
          dialog.setAttribute('open', 'open');
        }
      }

      async function submitForm(event) {
        event.preventDefault();
        if (!ensureAuthorized(true)) {
          formMessage.textContent = 'Acesso expirado. Abra novamente pelo botão "admin".';
          return;
        }
        formMessage.textContent = '';
        const formData = new FormData(form);
        const payload = {
          id: formData.get('id') || undefined,
          data: formData.get('data'),
          horario: formData.get('horario'),
          shopping: formData.get('shopping'),
          nome_fantasia: formData.get('nome_fantasia'),
          nome_contato: formData.get('nome_contato'),
          telefone_whatsapp: formData.get('telefone_whatsapp'),
          email: formData.get('email'),
          informacoes_adicionais: formData.get('informacoes_adicionais'),
          status: formData.get('status'),
          upload_url: formData.get('upload_url'),
          upload_tipo: formData.get('upload_tipo'),
          upload_tamanho_mb: formData.get('upload_tamanho_mb'),
          data_hora_reserva: formData.get('data_hora_reserva'),
          expira_em: formData.get('expira_em')
        };

        if (!payload.data || !payload.horario) {
          formMessage.textContent = 'Campos data e horário são obrigatórios.';
          return;
        }

        try {
          const response = await fetch('/api/admin/agenda', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${state.token}`
            },
            body: JSON.stringify(payload)
          });

          if (response.status === 401 || response.status === 403) {
            handleUnauthorized();
            formMessage.textContent = 'Sessão expirada. Abra novamente pelo botão "admin".';
            return;
          }

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            const message = errorPayload.message || 'Não foi possível salvar.';
            throw new Error(message);
          }

          closeDialog();
          await loadAgenda();
          showToast('Informações salvas com sucesso');
        } catch (error) {
          formMessage.textContent = error.message;
        }
      }

      function closeDialog() {
        if (typeof dialog.close === 'function') {
          dialog.close();
        } else {
          dialog.removeAttribute('open');
        }
        formMessage.textContent = '';
      }

      async function handleDelete(id, rowKey) {
        if (!id) return;
        if (!ensureAuthorized(true)) return;
        const confirmed = window.confirm('Confirma liberar este horário e remover o registro do JSON?');
        if (!confirmed) return;

        try {
          const response = await fetch(`/api/admin/agenda/${id}`, {
            method: 'DELETE',
            headers: {
              Authorization: `Bearer ${state.token}`
            }
          });

          if (response.status === 401 || response.status === 403) {
            handleUnauthorized();
            return;
          }

          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            throw new Error(payload.message || 'Erro ao remover agendamento.');
          }
          if (rowKey && state.selectedRowKey === rowKey) {
            state.selectedRowKey = null;
            renderDetailPanel(null);
          }
          await loadAgenda();
          showToast('Horário liberado');
        } catch (error) {
          showToast(error.message, true);
        }
      }

      function openFirstAvailableSlot() {
        if (!ensureAuthorized(true)) return;
        const slot = state.agenda.find((item) => item.status === 'disponivel');
        if (!slot) {
          showToast('Nenhum horário disponível para reserva.', true);
          return;
        }
        state.selectedRowKey = slot.rowKey;
        highlightSelectedRow();
        renderDetailPanel(slot);
        openEditor(slot);
      }

      function exportAgendaToCsv() {
        if (!state.agenda.length) {
          showToast('Não há dados para exportar.', true);
          return;
        }
        const headers = [
          'Data',
          'Horário',
          'Status',
          'Shopping',
          'Nome fantasia',
          'Contato',
          'Telefone',
          'E-mail',
          'Informações',
          'Upload URL',
          'Upload tipo',
          'Upload tamanho',
          'Reservado em',
          'Expira em'
        ];
        const csvRows = [headers.join(';')];
        state.agenda.forEach((item) => {
          const upload = item.upload_arquivo || {};
          const row = [
            formatDate(item.data),
            item.horario,
            statusLabel(item.status),
            item.shopping || '',
            item.nome_fantasia || '',
            item.nome_contato || '',
            item.telefone_whatsapp || '',
            item.email || '',
            item.informacoes_adicionais || '',
            upload.url || '',
            upload.tipo || '',
            upload.tamanho_mb || '',
            formatDateTime(item.data_hora_reserva),
            formatDateTime(item.expira_em)
          ].map((value) => `"${String(value ?? '').replace(/"/g, '""')}"`);
          csvRows.push(row.join(';'));
        });
        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const stamp = new Date().toISOString().split('T')[0];
        link.download = `agenda-${stamp}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showToast('Arquivo CSV gerado');
      }

      function releaseSelectedSlot() {
        const row = getSelectedRow();
        if (!row || !row.id) {
          showToast('Selecione um agendamento reservado para liberar.', true);
          return;
        }
        handleDelete(row.id, row.rowKey);
      }

      function handleTableClick(event) {
        const editBtn = event.target.closest('.edit-btn');
        if (editBtn) {
          const { rowKey } = editBtn.dataset;
          const row = state.agenda.find((item) => item.rowKey === rowKey);
          if (row) {
            state.selectedRowKey = row.rowKey;
            highlightSelectedRow();
            renderDetailPanel(row);
            openEditor(row);
          }
          return;
        }

        const deleteBtn = event.target.closest('.delete-btn');
        if (deleteBtn) {
          handleDelete(deleteBtn.dataset.id, deleteBtn.dataset.rowKey);
          return;
        }

        const rowElement = event.target.closest('tr[data-row-key]');
        if (rowElement) {
          state.selectedRowKey = rowElement.dataset.rowKey;
          highlightSelectedRow();
          renderDetailPanel(getSelectedRow());
        }
      }

      function showToast(message, isError = false) {
        toast.textContent = message;
        toast.style.background = isError ? '#ff7c6b' : 'var(--primary)';
        toast.classList.add('show');
        clearTimeout(showToast.timeoutId);
        showToast.timeoutId = setTimeout(() => {
          toast.classList.remove('show');
        }, 3500);
      }

      function logoutFromPanel() {
        clearToken();
        state.agenda = [];
        state.dates = [];
        state.slots = [];
        state.selectedRowKey = null;
        setTableMessage(`Sessão encerrada. ${ADMIN_LOGIN_HINT}`);
        buildDayCarousel();
        updateHeroSummary();
        showToast('Sessão encerrada.');
      }

      if (clearDateButton) {
        clearDateButton.addEventListener('click', () => {
          dateFilter.value = '';
          renderTable();
          buildDayCarousel();
        });
      }

      dateFilter.addEventListener('change', () => {
        renderTable();
        buildDayCarousel();
      });
      statusFilter.addEventListener('change', renderTable);
      searchFilter.addEventListener('input', () => {
        renderTable();
      });
      refreshButton.addEventListener('click', loadAgenda);
      logoutButton.addEventListener('click', logoutFromPanel);
      tableBody.addEventListener('click', handleTableClick);
      form.addEventListener('submit', submitForm);
      cancelEditBtn.addEventListener('click', closeDialog);
      dialog.addEventListener('cancel', (event) => {
        event.preventDefault();
        closeDialog();
      });
      if (detailPanel) {
        detailPanel.addEventListener('click', (event) => {
          const button = event.target.closest('[data-action]');
          if (!button) return;
          const rowKey = button.dataset.rowKey;
          const row = state.agenda.find((item) => item.rowKey === rowKey);
          if (!row) return;
          if (button.dataset.action === 'edit') {
            state.selectedRowKey = row.rowKey;
            highlightSelectedRow();
            renderDetailPanel(row);
            openEditor(row);
          }
          if (button.dataset.action === 'release') {
            handleDelete(button.dataset.id, row.rowKey);
          }
        });
      }
      if (quickReserveBtn) {
        quickReserveBtn.addEventListener('click', openFirstAvailableSlot);
      }
      if (quickExportBtn) {
        quickExportBtn.addEventListener('click', exportAgendaToCsv);
      }
      if (quickReleaseSelectedBtn) {
        quickReleaseSelectedBtn.addEventListener('click', releaseSelectedSlot);
      }

      if (state.token) {
        loadAgenda();
      } else {
        ensureAuthorized();
      }
    })();
  </script>
</body>
</html>
